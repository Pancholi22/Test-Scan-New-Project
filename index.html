<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Scan Diagnostic — DWT + Local Network Access</title>

  <!-- Keep your Dynamsoft files in Resources/ inside the extension -->
  <script type="text/javascript" src="Resources/dynamsoft.webtwain.initiate.js"></script>
  <script type="text/javascript" src="Resources/dynamsoft.webtwain.config.js"></script>

  <style>
    body { font-family: Arial, Helvetica, sans-serif; margin: 18px; }
    #status { margin: 12px 0; padding: 8px; border: 1px solid #ddd; background:#fafafa; }
    #log { margin-top:12px; white-space: pre-wrap; border:1px solid #eee; padding:8px; height:200px; overflow:auto; background:#fff; }
    button { margin-right:8px; }
    .err { color: #9b1b1b; }
    .ok { color: #15621f; }
  </style>
</head>
<body>
  <h2>Scan Diagnostic — Dynamic Web TWAIN (DWT)</h2>

  <div id="status">
    <div><strong>Origin:</strong> <span id="origin"></span></div>
    <div><strong>LNA state:</strong> <span id="lnaState">checking…</span></div>
    <div><strong>Iframe:</strong> <span id="isIframe"></span></div>
    <div><strong>DWT ready:</strong> <span id="dwtReady">no</span></div>
    <div id="bcHint" style="margin-top:8px;font-size:0.95em;color:#333;"></div>
  </div>

  <div>
    <button id="btnTestLocal">Test local scanner service (probe)</button>
    <button id="btnScan">Scan (AcquireImage)</button>
    <button id="btnOpenChromeSettings">Open Chrome site settings for this origin</button>
  </div>

  <div style="margin-top: 10px;">
    <div id="dwtcontrolContainer" style="width:350px;height:380px;border:1px dashed #ccc;margin-top:12px;"></div>
  </div>

  <h4>Console-style log</h4>
  <div id="log"></div>

  <script>
    // ------------------------------
    // Configuration — set BC origin from your message
    // ------------------------------
    const BC_ORIGIN = 'http://localhost:8080'; // <<-- your Business Central origin

    // Small logger
    function log(msg, level) {
      const el = document.getElementById('log');
      const time = new Date().toISOString();
      el.textContent += '[' + time + '] ' + (level ? ('['+level.toUpperCase()+'] ') : '') + msg + '\\n';
      el.scrollTop = el.scrollHeight;
      console.log(msg);
    }

    document.getElementById('origin').textContent = window.location.origin || 'file:// (local file)';
    document.getElementById('isIframe').textContent = (window.self !== window.top) ? 'YES (inside iframe)' : 'NO (top window)';

    // Helper to open Chrome site settings for the BC origin
    document.getElementById('btnOpenChromeSettings').addEventListener('click', function() {
      const encoded = encodeURIComponent(BC_ORIGIN);
      const chromeUrl = 'chrome://settings/content/siteDetails?site=' + encoded;
      log('Open this in Chrome to allow Local network access for the BC origin: ' + chromeUrl);
      try { window.open(chromeUrl, '_blank'); } catch(e) { log('Could not open chrome:// URL programmatically. Open manually: ' + chromeUrl, 'warn'); }
      alert('Open Chrome and visit:\n\n' + chromeUrl + '\n\nThen set "Local network access" to Allow for this origin.');
    });

    // ------------------------------
    // LNA permission check (improved UX)
    // ------------------------------
    async function checkLNA() {
      const statusEl = document.getElementById('lnaState');
      try {
        if (!navigator.permissions || !navigator.permissions.query) {
          statusEl.textContent = 'Permissions API not supported';
          log('Permissions API not supported by this browser.');
          return;
        }
        const p = await navigator.permissions.query({ name: 'local-network-access' });
        statusEl.textContent = p.state;
        log('LNA permission state: ' + p.state);
        p.onchange = () => { statusEl.textContent = p.state; log('LNA state changed to: ' + p.state); };

        // Provide inline hint for BC origin if not granted
        const bcHintEl = document.getElementById('bcHint');
        if (p.state === 'denied') {
          bcHintEl.innerHTML = 'Local Network Access is <span class="err">denied</span>. Grant it for Business Central origin: <code>' + BC_ORIGIN + '</code>. Click "Open Chrome site settings" above.';
        } else if (p.state === 'prompt') {
          bcHintEl.innerHTML = 'Local Network Access needs to be allowed by Chrome for this origin. You will be prompted when DWT tries to access local network. Click "Scan" and allow the prompt.';
        } else if (p.state === 'granted') {
          bcHintEl.innerHTML = '<span class="ok">Local Network Access granted</span> for this origin.';
        } else {
          bcHintEl.innerHTML = 'LNA state: ' + p.state;
        }
      } catch (e) {
        document.getElementById('lnaState').textContent = 'unsupported';
        log('Error checking LNA permission (likely unsupported): ' + e, 'warn');
      }
    }

    // Run check on load
    checkLNA();

    // ------------------------------
    // Probe local scanner service (two common hosts)
    // ------------------------------
    async function probeLocalService() {
      const urls = [
        'http://127.0.0.1:18622',
        'http://localhost:18622',
        'http://127.0.0.1:18623',
        'http://localhost:18623'
      ];

      for (const url of urls) {
        try {
          log('Probing ' + url + ' ...');
          const controller = new AbortController();
          const timeout = setTimeout(() => controller.abort(), 3000);
          const resp = await fetch(url, { method: 'GET', mode: 'no-cors', signal: controller.signal });
          clearTimeout(timeout);
          log('Probe attempt to ' + url + ' completed (no-cors). Response object: ' + JSON.stringify({
            ok: (resp && resp.ok) || false,
            type: (resp && resp.type) || 'unknown',
            status: (resp && resp.status) || 'unknown'
          }));
        } catch (err) {
          log('Probe to ' + url + ' failed: ' + (err && err.message ? err.message : String(err)), 'error');
        }
      }
      log('Probe finished. If all probes failed, check scanner service and firewall.');
    }

    document.getElementById('btnTestLocal').addEventListener('click', probeLocalService);

    // ------------------------------
    // Dynamsoft WebTWAIN initialization and better error reporting
    // ------------------------------
    var DWTObject = null;
    document.getElementById('dwtReady').textContent = 'no';

    try {
      Dynamsoft.DWT.RegisterEvent('OnWebTwainReady', function() {
        try {
          DWTObject = Dynamsoft.DWT.GetWebTwain('dwtcontrolContainer');
          document.getElementById('dwtReady').textContent = 'yes';
          log('DWT ready. WebTwain object obtained.');
          log('DWT version info: ' + (Dynamsoft && Dynamsoft.DWT && Dynamsoft.DWT.GetDWTVersion ? Dynamsoft.DWT.GetDWTVersion() : 'unknown'));
        } catch (e) {
          log('Error during OnWebTwainReady handler: ' + e, 'error');
        }
      });
    } catch (err) {
      log('Error registering OnWebTwainReady: ' + err, 'error');
    }

    function showErrorToUser(title, msg) {
      log(title + ' - ' + msg, 'error');
      alert(title + '\\n\\n' + msg);
    }

    async function AcquireImage() {
      // Re-check LNA before starting
      try {
        const p = await navigator.permissions.query({ name: 'local-network-access' });
        if (p.state !== 'granted') {
          showErrorToUser('Local Network Access not granted', 'Chrome has not granted Local Network Access for this origin. Please open site settings and allow it for ' + BC_ORIGIN + '.');
          return;
        }
      } catch (e) {
        // proceed but warn
        log('Could not confirm LNA state before AcquireImage: ' + e, 'warn');
      }

      if (!DWTObject) {
        showErrorToUser('Not Ready', 'DWT object not ready. Wait a few seconds and retry. Check browser console for details.');
        return;
      }

      try {
        log('Calling SelectSourceAsync()...');
        await DWTObject.SelectSourceAsync();
        log('SelectSourceAsync succeeded.');
      } catch (err) {
        const m = err && err.message ? err.message : JSON.stringify(err);
        log('SelectSourceAsync failed: ' + m, 'error');
        let hint = '';
        if (/local network/i.test(m) || /permission/i.test(m)) {
          hint = 'Chrome Local Network Access may be denied for this origin. Ensure iframe has allow="local-network-access" and BC add-in has RequestedPermissions.';
        } else if (/timeout|connect/i.test(m)) {
          hint = 'Could not reach the local scanner service. Is the scanner service running? Check port (18622) and firewall.';
        } else {
          hint = 'Check browser console, network tab, and ensure local scanner service is reachable and CORS/HTTPS issues are addressed.';
        }
        showErrorToUser('SelectSourceAsync failed', m + '\\n\\nHint: ' + hint);
        return;
      }

      try {
        log('Calling AcquireImageAsync()...');
        const res = await DWTObject.AcquireImageAsync({ IfCloseSourceAfterAcquire: true });
        log('AcquireImageAsync result: ' + JSON.stringify(res));
        alert('Scan completed successfully.');
      } catch (err) {
        const m = err && err.message ? err.message : JSON.stringify(err);
        log('AcquireImageAsync failed: ' + m, 'error');
        let hint = '';
        if (/local network/i.test(m) || /permission/i.test(m)) {
          hint = 'Local Network Access permission might be denied for this origin. See chrome://settings/content/siteDetails?site=' + encodeURIComponent(BC_ORIGIN);
        } else if (/no response|connect|ECONNREFUSED/i.test(m)) {
          hint = 'Local scanner service not reachable (connection refused). Make sure the scanner service is running and not blocked by firewall.';
        } else {
          hint = 'Check Browser Console (F12) → Network tab for blocked calls to localhost; check CORS and Mixed Content (HTTP vs HTTPS).';
        }
        showErrorToUser('AcquireImageAsync failed', m + '\\n\\nHint: ' + hint);
      }
    }

    document.getElementById('btnScan').addEventListener('click', AcquireImage);

    // Print helpful notes to the log
    log('Diagnostic helper loaded. Checklist:');
    log('1) BC origin: ' + BC_ORIGIN + ' — make sure Chrome site settings grants Local Network Access for this origin.');
    log('2) If inside Business Central iframe: the control add-in must include RequestedPermissions = "local-network-access".');
    log('3) If the page is cross-origin (GitHub Pages), the embedding iframe chain must include allow="local-network-access". Otherwise bundle the page into the extension.');
    log('4) Check DevTools Console / Network for exact blocked request messages.');

    // AL control add-in snippet for reference
    log('AL Control Add-in snippet (example):');
    log("controladdin MyScanAddin\\n{\\n  Scripts = 'index.html';\\n  RequestedPermissions = 'local-network-access';\\n}\\n");

  </script>
</body>
</html>
